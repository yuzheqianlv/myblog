{% set content_class = class | default(value="markdown-content") %}
{% set enable_toc = toc | default(value=false) %}
{% set enable_copy = copy | default(value=true) %}
{% set enable_line_numbers = line_numbers | default(value=false) %}
{% set enable_highlight_lines = highlight_lines | default(value=false) %}

<div class="{{ content_class }}{% if enable_toc %} with-toc{% endif %}{% if enable_line_numbers %} with-line-numbers{% endif %}" 
     data-markdown-shortcode="true">
    
    <!-- å¯é€‰çš„æ ‡é¢˜ -->
    {% if title %}
    <header class="markdown-header">
        <h3 class="markdown-title">{{ title }}</h3>
        {% if description %}
        <p class="markdown-description">{{ description }}</p>
        {% endif %}
    </header>
    {% endif %}

    <!-- å¯é€‰çš„ç›®å½• -->
    {% if enable_toc %}
    <nav class="markdown-toc">
        <h4 class="toc-title">ç›®å½•</h4>
        <div class="toc-content" id="markdown-toc-{{ id | default(value='default') }}">
            <!-- TOC will be generated by JavaScript -->
        </div>
    </nav>
    {% endif %}

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="markdown-body" id="markdown-body-{{ id | default(value='default') }}">
        {{ body | markdown | safe }}
    </div>

    <!-- å¯é€‰çš„ä»£ç å¤åˆ¶åŠŸèƒ½ -->
    {% if enable_copy %}
    <script>
        // ä»£ç å—å¤åˆ¶åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const markdownContainer = document.querySelector('[data-markdown-shortcode="true"]');
            if (!markdownContainer) return;

            // ä¸ºæ‰€æœ‰ä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
            const codeBlocks = markdownContainer.querySelectorAll('pre code');
            codeBlocks.forEach((codeBlock, index) => {
                const pre = codeBlock.parentElement;
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                
                // åˆ›å»ºç®€çº¦çš„å¤åˆ¶æŒ‰é’®
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-code-btn';
                copyBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>';
                copyBtn.setAttribute('aria-label', 'å¤åˆ¶ä»£ç ');
                copyBtn.setAttribute('tabindex', '0');
                copyBtn.onclick = () => copyCode(copyBtn, codeBlock);
                
                // é”®ç›˜æ”¯æŒ
                copyBtn.onkeydown = (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        copyCode(copyBtn, codeBlock);
                    }
                };
                
                // åŒ…è£…ä»£ç å—
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(copyBtn);
                wrapper.appendChild(pre);
            });

            {% if enable_toc %}
            // ç”Ÿæˆç›®å½•
            generateTableOfContents();
            {% endif %}
        });

        function copyCode(button, codeElement) {
            const code = codeElement.textContent;
            navigator.clipboard.writeText(code).then(() => {
                const originalHtml = button.innerHTML;
                
                // æ˜¾ç¤ºæˆåŠŸå›¾æ ‡
                button.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                button.classList.add('copied');
                
                // 2ç§’åæ¢å¤åŸçŠ¶
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                const originalHtml = button.innerHTML;
                
                // æ˜¾ç¤ºé”™è¯¯å›¾æ ‡
                button.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
                button.classList.add('copy-error');
                
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.classList.remove('copy-error');
                }, 2000);
            });
        }

        {% if enable_toc %}
        function generateTableOfContents() {
            const tocContainer = document.getElementById('markdown-toc-{{ id | default(value="default") }}');
            const content = document.getElementById('markdown-body-{{ id | default(value="default") }}');
            if (!tocContainer || !content) return;

            const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
            if (headings.length === 0) {
                tocContainer.innerHTML = '<p class="no-headings">æ²¡æœ‰æ‰¾åˆ°æ ‡é¢˜</p>';
                return;
            }

            const tocList = document.createElement('ul');
            tocList.className = 'toc-list';

            headings.forEach((heading, index) => {
                // ç¡®ä¿æ ‡é¢˜æœ‰ID
                if (!heading.id) {
                    heading.id = `heading-${index + 1}`;
                }

                const li = document.createElement('li');
                li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;

                const link = document.createElement('a');
                link.href = `#${heading.id}`;
                link.textContent = heading.textContent;
                link.className = 'toc-link';
                
                // å¹³æ»‘æ»šåŠ¨
                link.onclick = (e) => {
                    e.preventDefault();
                    heading.scrollIntoView({ behavior: 'smooth' });
                    history.pushState(null, null, `#${heading.id}`);
                };

                li.appendChild(link);
                tocList.appendChild(li);
            });

            tocContainer.appendChild(tocList);
        }
        {% endif %}
    </script>
    {% endif %}
</div>

<style>
/* åŸºç¡€å®¹å™¨æ ·å¼ */
.markdown-content {
    line-height: 1.7;
    font-size: 1rem;
    color: var(--text-color);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

/* æ ‡é¢˜åŒºåŸŸ */
.markdown-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.markdown-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--title-color);
}

.markdown-description {
    margin: 0;
    color: var(--secondary-color);
    font-style: italic;
}

/* ç›®å½•æ ·å¼ */
.markdown-toc {
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-light);
}

.toc-title {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--title-color);
    display: flex;
    align-items: center;
}

.toc-title::before {
    content: 'ğŸ“‹';
    margin-right: 0.5rem;
}

.toc-list {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

.toc-item {
    margin: 0.3rem 0;
}

.toc-h1 { padding-left: 0; font-weight: 600; }
.toc-h2 { padding-left: 1rem; }
.toc-h3 { padding-left: 2rem; }
.toc-h4 { padding-left: 3rem; }
.toc-h5 { padding-left: 4rem; }
.toc-h6 { padding-left: 5rem; }

.toc-link {
    color: var(--text-color);
    text-decoration: none;
    display: block;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    transition: all 0.2s ease;
    font-size: 0.9rem;
}

.toc-link:hover {
    background: var(--hover-color);
    color: var(--primary-color);
    transform: translateX(4px);
}

.no-headings {
    color: var(--muted-color);
    font-style: italic;
    text-align: center;
    margin: 0;
}

/* å†…å®¹ä¸»ä½“æ ·å¼ */
.markdown-body {
    max-width: none;
}

/* æ ‡é¢˜æ ·å¼ - å¢å¼ºç‰ˆ */
.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
    margin: 2.5rem 0 1rem 0;
    font-weight: 600;
    color: var(--title-color);
    line-height: 1.3;
    scroll-margin-top: 4rem; /* ä¸ºå›ºå®šå¯¼èˆªæ é¢„ç•™ç©ºé—´ */
}

.markdown-content h1 {
    font-size: 2.25rem;
    margin-top: 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

.markdown-content h2 {
    font-size: 1.875rem;
    margin-top: 3rem;
    position: relative;
}

.markdown-content h2::before {
    content: '';
    position: absolute;
    left: -1rem;
    top: 0.5rem;
    width: 4px;
    height: 1.5rem;
    background: var(--primary-color);
    border-radius: 2px;
}

.markdown-content h3 {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.markdown-content h4 {
    font-size: 1.25rem;
}

.markdown-content h5 {
    font-size: 1.125rem;
}

.markdown-content h6 {
    font-size: 1rem;
    color: var(--secondary-color);
}

/* æ®µè½æ ·å¼ */
.markdown-content p {
    margin: 1.2rem 0;
    color: var(--text-color);
    line-height: 1.8;
}

/* å¢å¼ºçš„ä»£ç æ ·å¼ */
.code-block-wrapper {
    position: relative;
    margin: 1.5rem 0;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-medium);
}

.copy-code-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
    color: var(--text-color);
    opacity: 0.7;
}

.copy-code-btn:hover {
    opacity: 1;
    background: rgba(66, 185, 131, 0.2);
    border-color: rgba(66, 185, 131, 0.4);
    transform: scale(1.05);
}

.copy-code-btn:active {
    transform: scale(0.95);
}

.copy-code-btn:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

.copy-code-btn.copied {
    background: rgba(16, 185, 129, 0.2);
    border-color: rgba(16, 185, 129, 0.4);
    color: var(--success-color);
}

.copy-code-btn.copy-error {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
    color: var(--error-color);
}

/* æš—è‰²ä¸»é¢˜ä¸‹çš„æŒ‰é’®æ ·å¼ */
[data-theme="dark"] .copy-code-btn {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--text-color);
}

[data-theme="dark"] .copy-code-btn:hover {
    background: rgba(92, 203, 145, 0.2);
    border-color: rgba(92, 203, 145, 0.4);
}

/* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
@media (hover: none) and (pointer: coarse) {
    .copy-code-btn {
        opacity: 1;
        width: 40px;
        height: 40px;
    }
    
    .copy-code-btn:hover {
        transform: none;
    }
    
    .copy-code-btn:active {
        transform: scale(0.9);
        background: rgba(66, 185, 131, 0.3);
    }
}

/* è¡Œå†…ä»£ç æ ·å¼ */
.markdown-content code:not(pre code) {
    padding: 0.2rem 0.4rem;
    font-size: 0.875rem;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    background: var(--inline-code-bg);
    border: 1px solid var(--code-border);
    border-radius: 4px;
    color: var(--inline-code-color);
    font-weight: 500;
}

/* ä»£ç å—æ ·å¼ */
.markdown-content pre {
    margin: 0;
    padding: 1.2rem;
    overflow-x: auto;
    background: var(--code-bg);
    font-size: 0.9rem;
    line-height: 1.6;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
}

.markdown-content pre code {
    padding: 0;
    background: none;
    border: none;
    color: var(--code-color);
    font-size: inherit;
    line-height: inherit;
}

/* å¢å¼ºçš„åˆ—è¡¨æ ·å¼ */
.markdown-content ul,
.markdown-content ol {
    padding-left: 1.5rem;
    margin: 1.2rem 0;
}

.markdown-content li {
    margin: 0.5rem 0;
    line-height: 1.7;
}

.markdown-content ul > li {
    position: relative;
}

.markdown-content ul > li::marker {
    color: var(--primary-color);
}

.markdown-content ol > li::marker {
    color: var(--primary-color);
    font-weight: 600;
}

/* åµŒå¥—åˆ—è¡¨ */
.markdown-content li > ul,
.markdown-content li > ol {
    margin: 0.5rem 0;
}

/* å¢å¼ºçš„å¼•ç”¨æ ·å¼ */
.markdown-content blockquote {
    margin: 2rem 0;
    padding: 1rem 1.5rem;
    border-left: 4px solid var(--primary-color);
    background: var(--hover-color);
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    color: var(--text-color);
    position: relative;
    box-shadow: var(--shadow-light);
}

.markdown-content blockquote::before {
    content: '"';
    position: absolute;
    top: -0.5rem;
    left: 1rem;
    font-size: 3rem;
    color: var(--primary-color);
    opacity: 0.3;
    font-family: Georgia, serif;
}

.markdown-content blockquote p {
    margin: 0.5rem 0;
    font-style: italic;
}

.markdown-content blockquote p:first-child {
    margin-top: 0;
}

.markdown-content blockquote p:last-child {
    margin-bottom: 0;
}

/* å›¾ç‰‡æ ·å¼å¢å¼º */
.markdown-content img {
    max-width: 100%;
    height: auto;
    border-radius: var(--border-radius);
    margin: 1.5rem 0;
    box-shadow: var(--shadow-medium);
    transition: transform 0.3s ease;
}

.markdown-content img:hover {
    transform: scale(1.02);
}

/* è¡¨æ ¼æ ·å¼å¢å¼º */
.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    background: var(--bg-color);
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-medium);
    border: 1px solid var(--border-color);
}

.markdown-content th,
.markdown-content td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    vertical-align: top;
}

.markdown-content th {
    background: var(--hover-color);
    font-weight: 600;
    color: var(--title-color);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.markdown-content tr:nth-child(even) td {
    background: rgba(0, 0, 0, 0.02);
}

.markdown-content tr:hover td {
    background: var(--hover-color);
}

/* æ°´å¹³çº¿æ ·å¼ */
.markdown-content hr {
    margin: 3rem 0;
    border: none;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--border-color), transparent);
}

/* é“¾æ¥æ ·å¼å¢å¼º */
.markdown-content a {
    color: var(--primary-color);
    text-decoration: none;
    position: relative;
    transition: all 0.2s ease;
}

.markdown-content a::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--primary-color);
    transition: width 0.3s ease;
}

.markdown-content a:hover::after {
    width: 100%;
}

.markdown-content a:hover {
    color: var(--primary-dark);
}

/* å¤–éƒ¨é“¾æ¥å›¾æ ‡ */
.markdown-content a[href^="http"]::before {
    content: 'ğŸ”—';
    margin-right: 0.2rem;
    font-size: 0.8rem;
    opacity: 0.7;
}

/* ä»£ç å—ä¸­çš„é“¾æ¥ä¸éœ€è¦ç‰¹æ®Šæ ·å¼ */
.markdown-content pre a,
.markdown-content pre a::after,
.markdown-content pre a::before,
.markdown-content code a,
.markdown-content code a::after,
.markdown-content code a::before {
    all: unset;
    color: inherit;
}

/* å¼ºè°ƒæ–‡æœ¬æ ·å¼ */
.markdown-content strong {
    font-weight: 700;
    color: var(--title-color);
}

.markdown-content em {
    font-style: italic;
    color: var(--primary-color);
}

/* åˆ é™¤çº¿æ–‡æœ¬ */
.markdown-content del {
    text-decoration: line-through;
    color: var(--muted-color);
    opacity: 0.7;
}

/* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
.markdown-content ul li input[type="checkbox"] {
    margin-right: 0.5rem;
    transform: scale(1.2);
    accent-color: var(--primary-color);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .markdown-content {
        font-size: 0.95rem;
    }
    
    .markdown-content h1 {
        font-size: 1.8rem;
    }
    
    .markdown-content h2 {
        font-size: 1.5rem;
    }
    
    .markdown-content h2::before {
        display: none;
    }
    
    .markdown-content h3 {
        font-size: 1.3rem;
    }
    
    .markdown-toc {
        padding: 1rem;
    }
    
    .copy-code-btn {
        width: 36px;
        height: 36px;
        top: 0.4rem;
        right: 0.4rem;
    }
    
    .markdown-content pre {
        padding: 1rem;
        font-size: 0.85rem;
    }
    
    .markdown-content blockquote {
        margin: 1.5rem 0;
        padding: 0.8rem 1rem;
    }
    
    .markdown-content table {
        font-size: 0.85rem;
    }
    
    .markdown-content th,
    .markdown-content td {
        padding: 0.5rem 0.7rem;
    }
}

/* æš—è‰²ä¸»é¢˜é€‚é… */
[data-theme="dark"] .markdown-content {
    --code-bg: var(--code-bg);
    --code-color: var(--code-color);
    --inline-code-bg: var(--inline-code-bg);
    --inline-code-color: var(--inline-code-color);
}


[data-theme="dark"] .markdown-content img {
    opacity: 0.9;
}

[data-theme="dark"] .markdown-content tr:nth-child(even) td {
    background: rgba(255, 255, 255, 0.02);
}

/* æ‰“å°æ ·å¼ */
@media print {
    .code-toolbar,
    .copy-code-btn,
    .markdown-toc {
        display: none !important;
    }
    
    .markdown-content {
        font-size: 12pt;
        line-height: 1.5;
    }
    
    .markdown-content a::after {
        content: " (" attr(href) ")";
        font-size: 0.8em;
        color: #666;
    }
}

/* æ— éšœç¢æ”¯æŒ */
@media (prefers-reduced-motion: reduce) {
    .markdown-content *,
    .markdown-content *::before,
    .markdown-content *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* é«˜å¯¹æ¯”åº¦æ¨¡å¼æ”¯æŒ */
@media (prefers-contrast: high) {
    .markdown-content {
        --border-color: #000000;
        --primary-color: #0000ff;
    }
    
    .markdown-content code:not(pre code) {
        border: 2px solid;
    }
    
    .markdown-content table {
        border: 2px solid;
    }
    
    .markdown-content th,
    .markdown-content td {
        border: 1px solid;
    }
}
</style> 