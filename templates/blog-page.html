{% extends "base.html" %}

{% block title %}{{ page.title }} - {{ config.title }}{% endblock title %}

{% block description %}{{ page.description }}{% endblock description %}

{% block keywords %}
    {%- if page.taxonomies.tags -%}
        {{ page.taxonomies.tags | join(sep=",") }}
    {%- else -%}
        {{ config.extra.keywords }}
    {%- endif -%}
{% endblock keywords %}

{% block og_title %}{{ page.title }}{% endblock og_title %}
{% block og_description %}{{ page.description }}{% endblock og_description %}

{% block content %}
<article class="post">
    <header class="post-header">
        <h1 class="post-title">{{ page.title }}</h1>
        <div class="post-meta">
            <time>{{ page.date | date(format="%Y-%m-%d") }}</time>
            {% if page.taxonomies.tags %}
            <div class="post-tags">
                {% for tag in page.taxonomies.tags %}
                <a href="{{ get_taxonomy_url(kind="tags", name=tag) }}" class="tag">{{ tag }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </header>
    <div class="post-content" id="post-content">
        {{ page.content | safe }}
    </div>
</article>

<style>


/* æ–‡ç« å¡ç‰‡æ ·å¼ */
.post {
    background: var(--bg-color);
    border-radius: 8px;
    box-shadow: 0 1px 3px var(--shadow-color);
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

/* æ–‡ç« å¤´éƒ¨æ ·å¼ */
.post-header {
    padding: 2rem 2rem 0;
}

.post-title {
    margin: 0 0 1rem;
    font-size: 2rem;
    line-height: 1.3;
    color: var(--title-color);
}

.post-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
    color: var(--secondary-color);
    font-size: 0.9rem;
}

/* æ ‡ç­¾æ ·å¼ */
.post-tags {
    display: flex;
    gap: 0.5rem;
}

.tag {
    padding: 0.25rem 0.75rem;
    background: var(--bg-color);
    border: 1px solid var(--border-color);
    border-radius: 999px;
    color: var(--secondary-color);
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.tag:hover {
    background: var(--hover-color);
    border-color: var(--primary-color);
    color: var(--primary-color);
}

/* æ–‡ç« å†…å®¹æ ·å¼ */
.post-content {
    padding: 0 2rem 2rem;
    color: var(--text-color);
    line-height: 1.8;
}

/* æ ‡é¢˜é”šç‚¹æ ·å¼ */
.post-content h1,
.post-content h2,
.post-content h3,
.post-content h4,
.post-content h5,
.post-content h6 {
    position: relative;
    margin: 2rem 0 1rem;
    color: var(--title-color);
    scroll-margin-top: 3rem;
}

.post-content h1 { font-size: 2rem; }
.post-content h2 { font-size: 1.75rem; }
.post-content h3 { font-size: 1.5rem; }
.post-content h4 { font-size: 1.25rem; }
.post-content h5 { font-size: 1.125rem; }
.post-content h6 { font-size: 1rem; }

/* é”šç‚¹é“¾æ¥æ ·å¼ */
.anchor-link {
    position: absolute;
    left: -1.5rem;
    top: 50%;
    transform: translateY(-50%);
    display: inline-block;
    width: 1.2rem;
    height: 1.2rem;
    color: var(--secondary-color);
    text-decoration: none;
    opacity: 0;
    transition: all 0.2s;
    font-size: 1rem;
    text-align: center;
}

.post-content h1:hover .anchor-link,
.post-content h2:hover .anchor-link,
.post-content h3:hover .anchor-link,
.post-content h4:hover .anchor-link,
.post-content h5:hover .anchor-link,
.post-content h6:hover .anchor-link {
    opacity: 1;
}

.anchor-link:hover {
    color: var(--primary-color);
    transform: translateY(-50%) scale(1.1);
}

/* é«˜äº®ç›®æ ‡æ ‡é¢˜ */
.post-content h1:target,
.post-content h2:target,
.post-content h3:target,
.post-content h4:target,
.post-content h5:target,
.post-content h6:target {
    background: linear-gradient(90deg, rgba(66, 185, 131, 0.1), transparent);
    padding: 0.5rem;
    margin-left: -0.5rem;
    margin-right: -0.5rem;
    border-radius: 4px;
    animation: highlightTarget 2s ease-out;
}

@keyframes highlightTarget {
    0% { background: rgba(66, 185, 131, 0.3); }
    100% { background: rgba(66, 185, 131, 0.1); }
}

/* ä»£ç å—æ ·å¼ */
.post-content pre {
    margin: 1.5rem 0;
    padding: 1rem;
    background: var(--code-bg);
    border-radius: 8px;
    overflow-x: auto;
    border: 1px solid var(--border-color);
    position: relative;
}

.post-content code {
    font-family: Consolas, Monaco, 'Courier New', monospace;
    font-size: 0.9em;
    color: var(--code-color);
    padding: 0.2em 0.4em;
    background: var(--code-bg);
    border-radius: 3px;
}

.post-content pre code {
    padding: 0;
    background: none;
    display: block;
}

/* é“¾æ¥æ ·å¼ */
.post-content a {
    color: var(--link-color);
    text-decoration: none;
    border-bottom: 1px solid var(--link-color);
    opacity: 0.8;
    transition: all 0.2s;
}

.post-content a:hover {
    opacity: 1;
    border-bottom-width: 2px;
}

/* å¼•ç”¨æ ·å¼ */
.post-content blockquote {
    margin: 1.5rem 0;
    padding: 1rem 1.5rem;
    border-left: 4px solid var(--primary-color);
    background: var(--hover-color);
    border-radius: 4px;
    color: var(--text-color);
}

/* è¡¨æ ¼æ ·å¼ */
.post-content table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
}

.post-content th,
.post-content td {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-color);
    text-align: left;
}

.post-content th {
    background: var(--hover-color);
    font-weight: 600;
    color: var(--title-color);
}

.post-content tr:nth-child(even) {
    background: var(--hover-color);
}

/* åˆ—è¡¨æ ·å¼ */
.post-content ul,
.post-content ol {
    padding-left: 1.5rem;
    color: var(--text-color);
}

.post-content li {
    margin: 0.5rem 0;
}

/* å›¾ç‰‡æ ·å¼ */
.post-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
    border: 1px solid var(--border-color);
}

/* ç§»åŠ¨ç«¯æ–‡ç« æ ·å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .post-header {
        padding: 1.5rem 1.5rem 0;
    }

    .post-content {
        padding: 0 1.5rem 1.5rem;
    }

    .post-title {
        font-size: 1.75rem;
    }

    .anchor-link {
        left: -1rem;
        font-size: 0.9rem;
    }
}


/* æ·±è‰²æ¨¡å¼ä¸‹çš„ç‰¹æ®Šæ ·å¼ */
[data-theme="dark"] .post-content img {
    filter: brightness(0.8);
}

[data-theme="dark"] .post-content .highlight {
    filter: brightness(0.9);
}

[data-theme="dark"] .post-content tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.03);
}

[data-theme="dark"] .post-content blockquote {
    background: rgba(66, 185, 131, 0.1);
}
</style>

<script>
// å³ä¾§è¾¹æ ç›®å½•å’Œæ™ºèƒ½é”šç‚¹åŠŸèƒ½
class RightSidebarToc {
    constructor() {
        this.tocContainer = document.getElementById('toc-content');
        this.rightSidebar = document.getElementById('right-sidebar');
        this.postContent = document.getElementById('post-content');
        this.headings = [];
        this.currentActive = null;
        this.init();
    }

    init() {
        this.generateAnchors();
        this.generateTOC();
        this.setupScrollSpy();
        this.handleInitialHash();
        this.checkTocVisibility();
    }

    // ä¸ºæ ‡é¢˜ç”Ÿæˆé”šç‚¹
    generateAnchors() {
        const headings = this.postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
        
        headings.forEach((heading, index) => {
            // ç”ŸæˆIDï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
            if (!heading.id) {
                const text = heading.textContent.trim();
                const id = this.generateId(text, index);
                heading.id = id;
            }

            // æ·»åŠ é”šç‚¹é“¾æ¥
            const anchor = document.createElement('a');
            anchor.href = `#${heading.id}`;
            anchor.className = 'anchor-link';
            anchor.innerHTML = 'ğŸ”—';
            anchor.title = 'å¤åˆ¶é“¾æ¥';
            anchor.setAttribute('aria-label', 'é”šç‚¹é“¾æ¥');
            
            heading.appendChild(anchor);

            // å­˜å‚¨æ ‡é¢˜ä¿¡æ¯
            this.headings.push({
                element: heading,
                id: heading.id,
                text: heading.textContent.replace('ğŸ”—', '').trim(),
                level: parseInt(heading.tagName.substr(1))
            });

            // æ·»åŠ ç‚¹å‡»å¤åˆ¶åŠŸèƒ½
            anchor.addEventListener('click', (e) => {
                e.preventDefault();
                this.copyToClipboard(`${window.location.origin}${window.location.pathname}#${heading.id}`);
                this.scrollToHeading(heading);
                history.replaceState(null, null, `#${heading.id}`);
            });
        });
    }

    // ç”Ÿæˆå³ä¾§è¾¹æ ç›®å½•
    generateTOC() {
        if (this.headings.length === 0) {
            if (this.rightSidebar) {
                this.rightSidebar.style.display = 'none';
            }
            return;
        }

        const tocList = document.createElement('ul');
        
        this.headings.forEach(heading => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            
            a.href = `#${heading.id}`;
            a.textContent = this.truncateText(heading.text, 30); // æˆªæ–­é•¿æ ‡é¢˜
            a.className = `toc-h${heading.level}`;
            a.setAttribute('data-target', heading.id);
            a.title = heading.text; // å®Œæ•´æ ‡é¢˜ä½œä¸ºtooltip
            
            a.addEventListener('click', (e) => {
                e.preventDefault();
                this.scrollToHeading(heading.element);
                history.replaceState(null, null, `#${heading.id}`);
            });
            
            li.appendChild(a);
            tocList.appendChild(li);
        });
        
        this.tocContainer.appendChild(tocList);
    }

    // æˆªæ–­æ–‡æœ¬
    truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // è®¾ç½®æ»šåŠ¨ç›‘å¬
    setupScrollSpy() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const id = entry.target.id;
                const tocLink = this.tocContainer.querySelector(`a[data-target="${id}"]`);
                
                if (entry.isIntersecting) {
                    // ç§»é™¤ä¹‹å‰çš„æ¿€æ´»çŠ¶æ€
                    if (this.currentActive) {
                        this.currentActive.classList.remove('active');
                    }
                    
                    // è®¾ç½®æ–°çš„æ¿€æ´»çŠ¶æ€
                    if (tocLink) {
                        tocLink.classList.add('active');
                        this.currentActive = tocLink;
                        
                        // ç¡®ä¿æ¿€æ´»é¡¹åœ¨ç›®å½•å¯è§†åŒºåŸŸå†…
                        tocLink.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'nearest',
                            inline: 'nearest'
                        });
                    }
                }
            });
        }, {
            rootMargin: '-20% 0px -70% 0px',
            threshold: 0
        });

        this.headings.forEach(heading => {
            observer.observe(heading.element);
        });
    }


    // æ£€æŸ¥ç›®å½•å¯è§æ€§
    checkTocVisibility() {
        // å¦‚æœæ ‡é¢˜æ•°é‡å°‘äº3ä¸ªï¼Œéšè—ç›®å½•
        if (this.headings.length < 3 && this.rightSidebar) {
            this.rightSidebar.style.display = 'none';
        }
    }

    // å¤„ç†åˆå§‹å“ˆå¸Œ
    handleInitialHash() {
        if (window.location.hash) {
            const targetId = window.location.hash.substring(1);
            const targetElement = document.getElementById(targetId);
            if (targetElement) {
                // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åå†æ»šåŠ¨
                setTimeout(() => {
                    this.scrollToHeading(targetElement);
                }, 500);
            }
        }
    }


    // å¹³æ»‘æ»šåŠ¨åˆ°æ ‡é¢˜
    scrollToHeading(element) {
        const offsetTop = element.offsetTop - 100; // ç•™å‡ºä¸€äº›é¡¶éƒ¨ç©ºé—´
        window.scrollTo({
            top: offsetTop,
            behavior: 'smooth'
        });
    }

    // ç”Ÿæˆå”¯ä¸€ID
    generateId(text, index) {
        let id = text
            .toLowerCase()
            .replace(/[^\w\u4e00-\u9fa5\s-]/g, '') // ä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ã€ç©ºæ ¼ã€è¿å­—ç¬¦
            .replace(/\s+/g, '-') // å°†ç©ºæ ¼æ›¿æ¢ä¸ºè¿å­—ç¬¦
            .replace(/-+/g, '-') // åˆå¹¶å¤šä¸ªè¿å­—ç¬¦
            .replace(/^-|-$/g, ''); // ç§»é™¤é¦–å°¾è¿å­—ç¬¦

        // å¦‚æœIDä¸ºç©ºæˆ–å¤ªçŸ­ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
        if (!id || id.length < 2) {
            id = `heading-${index + 1}`;
        }

        // ç¡®ä¿IDå”¯ä¸€æ€§
        let finalId = id;
        let counter = 1;
        while (document.getElementById(finalId)) {
            finalId = `${id}-${counter}`;
            counter++;
        }

        return finalId;
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            this.showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            this.showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--primary-color);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 4px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out, slideOutRight 0.3s ease-in 2s forwards;
        `;

        document.body.appendChild(toast);

        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 2500);
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    new RightSidebarToc();
});

// æ·»åŠ åŠ¨ç”»æ ·å¼
const animationStyle = document.createElement('style');
animationStyle.textContent = `
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
`;
document.head.appendChild(animationStyle);
</script>

<!-- åœ¨æ–‡ç« é¡µé¢æ·»åŠ  Article ç»“æ„åŒ–æ•°æ® -->
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": "{{ page.title }}",
    "datePublished": "{{ page.date }}",
    "dateModified": "{{ page.updated | default(value=page.date) }}",
    "author": {
        "@type": "Person",
        "name": "{{ config.extra.author }}"
    },
    "description": "{{ page.description }}",
    "url": "{{ current_url | safe }}"
}
</script>
{% endblock content %}